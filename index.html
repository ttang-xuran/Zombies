<!DOCTYPE html>
<html>
<head>
    <title>TRULY GROUNDED REALISTIC ZOMBIES</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&display=swap');
        
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: #000;
            cursor: crosshair;
            font-family: 'Creepster', cursive;
        }
        #renderCanvas { 
            width: 100vw; 
            height: 100vh; 
            display: block;
        }
        #ui { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            color: #ff0000; 
            background: linear-gradient(135deg, rgba(20,0,0,0.95), rgba(40,10,10,0.9)); 
            padding: 25px; 
            border: 3px solid #ff0000;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000; 
            box-shadow: 0 0 30px rgba(255,0,0,0.5);
            text-shadow: 0 0 8px #ff0000;
        }
        .ui-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            min-width: 280px;
            align-items: center;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 1000;
        }
        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: #ff0000;
            box-shadow: 0 0 15px #ff0000;
        }
        #crosshair::before {
            width: 20px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #crosshair::after {
            width: 2px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #ffffff;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(60,20,20,0.9));
            padding: 20px;
            border: 2px solid #ff6600;
            border-radius: 15px;
            font-size: 16px;
            z-index: 1000;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/cannon.js"></script>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <div id="ui">
        <div class="ui-row">
            <span>‚ù§Ô∏è HEALTH:</span>
            <span id="health" style="color: #ff4444;">100</span>
        </div>
        <div class="ui-row">
            <span>üî´ AMMO:</span>
            <span id="ammo" style="color: #ffff44;">30</span>
        </div>
        <div class="ui-row">
            <span>üíÄ KILLS:</span>
            <span id="kills" style="color: #ff6666;">0</span>
        </div>
        <div class="ui-row">
            <span>üßü ZOMBIES:</span>
            <span id="zombieCount" style="color: #ff6600;">0</span>
        </div>
    </div>
    
    <div id="crosshair"></div>
    
    <div id="instructions">
        <div style="font-size: 20px; margin-bottom: 10px;"><strong>üö∂ GROUND WALKING ZOMBIES</strong></div>
        <div>‚Ä¢ Click to start ground-based survival</div>
        <div>‚Ä¢ WASD: Walk ON the ground (not fly)</div>
        <div>‚Ä¢ Mouse: Look around</div>
        <div>‚Ä¢ Left Click: Shoot walking zombies</div>
        <div>‚Ä¢ F: Toggle flashlight</div>
        <div style="color: #ff0000;">‚Ä¢ NO FLYING - Everything walks!</div>
    </div>

    <script>
        class TrulyGroundedGame {
            constructor() {
                this.canvas = document.getElementById("renderCanvas");
                this.engine = new BABYLON.Engine(this.canvas, true);
                this.scene = null;
                this.camera = null;
                this.zombies = [];
                
                // Game state
                this.health = 100;
                this.ammo = 30;
                this.kills = 0;
                this.isPointerLocked = false;
                this.gameStarted = false;
                this.lastShot = 0;
                this.shotCooldown = 150;
                
                // Input
                this.inputMap = {};
                
                // Ground level tracking
                this.groundLevel = 0;
                this.playerHeight = 1.7;
                
                this.init();
            }
            
            async init() {
                this.createScene();
                this.setupPhysics();
                this.createCamera();
                this.createLighting();
                this.createEnvironment();
                this.setupInput();
                this.startGame();
                this.gameLoop();
                
                window.addEventListener("resize", () => {
                    this.engine.resize();
                });
            }
            
            createScene() {
                this.scene = new BABYLON.Scene(this.engine);
                
                // Bright scene for visibility
                this.scene.ambientColor = new BABYLON.Color3(0.6, 0.55, 0.55);
                
                // Light fog
                this.scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
                this.scene.fogColor = new BABYLON.Color3(0.2, 0.15, 0.15);
                this.scene.fogDensity = 0.001;
            }
            
            setupPhysics() {
                // Enable physics
                this.scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());
            }
            
            createCamera() {
                // CRITICAL: Camera EXACTLY at walking height above ground
                this.camera = new BABYLON.FreeCamera("camera", 
                    new BABYLON.Vector3(0, this.playerHeight, 0), this.scene);
                this.camera.setTarget(new BABYLON.Vector3(0, this.playerHeight, 10));
                
                // PREVENT FLYING - Lock camera to ground level + player height
                this.camera.position.y = this.playerHeight;
                
                this.camera.speed = 0.5; // Slower, more realistic movement
                this.camera.angularSensibility = 2000;
            }
            
            createLighting() {
                // Very bright lighting
                const ambientLight = new BABYLON.HemisphericLight("ambient", 
                    new BABYLON.Vector3(0, 1, 0), this.scene);
                ambientLight.intensity = 1.2;
                ambientLight.diffuse = new BABYLON.Color3(1, 0.9, 0.9);
                
                // Strong directional light
                const dirLight = new BABYLON.DirectionalLight("dirLight", 
                    new BABYLON.Vector3(-0.5, -1, -0.5), this.scene);
                dirLight.intensity = 2;
                dirLight.diffuse = new BABYLON.Color3(1, 1, 0.95);
                
                // Flashlight
                this.flashlight = new BABYLON.SpotLight("flashlight", 
                    this.camera.position, 
                    this.camera.getForwardRay().direction, 
                    Math.PI / 1.5, 2, this.scene);
                this.flashlight.intensity = 15;
                this.flashlight.diffuse = new BABYLON.Color3(1, 1, 1);
                this.flashlight.range = 100;
                this.flashlight.parent = this.camera;
            }
            
            createEnvironment() {
                // Large visible ground
                const ground = BABYLON.MeshBuilder.CreateGround("ground", 
                    {width: 1000, height: 1000}, this.scene);
                ground.position.y = this.groundLevel; // Exactly at ground level
                
                const groundMaterial = new BABYLON.StandardMaterial("groundMat", this.scene);
                groundMaterial.diffuseColor = new BABYLON.Color3(0.5, 0.45, 0.4);
                ground.material = groundMaterial;
                
                // Buildings ON the ground
                this.createGroundedBuildings();
            }
            
            createGroundedBuildings() {
                const buildings = [
                    {pos: [-100, 0, -80], size: [40, 30, 45]},
                    {pos: [95, 0, -75], size: [35, 40, 40]},
                    {pos: [-70, 0, 90], size: [45, 25, 35]},
                    {pos: [80, 0, 85], size: [38, 45, 42]},
                ];
                
                buildings.forEach((config, i) => {
                    const building = BABYLON.MeshBuilder.CreateBox(`building${i}`, {
                        width: config.size[0],
                        height: config.size[1], 
                        depth: config.size[2]
                    }, this.scene);
                    
                    // Place building ON ground (half height above ground level)
                    building.position.set(config.pos[0], this.groundLevel + config.size[1]/2, config.pos[2]);
                    
                    const material = new BABYLON.StandardMaterial(`buildingMat${i}`, this.scene);
                    material.diffuseColor = new BABYLON.Color3(0.5, 0.45, 0.4);
                    building.material = material;
                });
            }
            
            setupInput() {
                this.scene.onPointerObservable.add((pointerInfo) => {
                    if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
                        if (!this.isPointerLocked) {
                            this.canvas.requestPointerLock();
                        } else {
                            this.shoot();
                        }
                    }
                });
                
                document.addEventListener('pointerlockchange', () => {
                    this.isPointerLocked = document.pointerLockElement === this.canvas;
                    if (this.isPointerLocked && !this.gameStarted) {
                        this.gameStarted = true;
                        setTimeout(() => this.spawnWalkingZombies(), 3000);
                    }
                });
                
                this.scene.onPointerObservable.add((pointerInfo) => {
                    if (this.isPointerLocked && pointerInfo.type === BABYLON.PointerEventTypes.POINTERMOVE) {
                        const deltaX = pointerInfo.event.movementX || 0;
                        const deltaY = pointerInfo.event.movementY || 0;
                        
                        this.camera.rotation.y += deltaX * 0.002;
                        this.camera.rotation.x += deltaY * 0.002;
                        this.camera.rotation.x = Math.max(-Math.PI/2.5, Math.min(Math.PI/2.5, this.camera.rotation.x));
                    }
                });
                
                this.scene.actionManager = new BABYLON.ActionManager(this.scene);
                
                const keys = ['w', 'a', 's', 'd', 'Escape', 'f', 'Shift'];
                keys.forEach(key => {
                    this.scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyDownTrigger, (evt) => {
                        if (evt.sourceEvent.key.toLowerCase() === key.toLowerCase()) {
                            this.inputMap[key] = true;
                        }
                    }));
                    
                    this.scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyUpTrigger, (evt) => {
                        if (evt.sourceEvent.key.toLowerCase() === key.toLowerCase()) {
                            this.inputMap[key] = false;
                        }
                    }));
                });
            }
            
            createHumanoidZombie() {
                console.log("Creating truly humanoid zombie...");
                
                // Container for zombie
                const zombieGroup = new BABYLON.TransformNode("humanoidZombie", this.scene);
                
                // REALISTIC HUMAN TORSO - Cylindrical like actual human body
                const torso = BABYLON.MeshBuilder.CreateCylinder("zombieTorso", {
                    height: 3.2, diameterTop: 1.8, diameterBottom: 1.4, tessellation: 16
                }, this.scene);
                torso.position.y = 1.6; // Half height above ground
                torso.parent = zombieGroup;
                
                // DECAYED HUMAN HEAD - More realistic skull shape
                const head = BABYLON.MeshBuilder.CreateSphere("zombieHead", {
                    diameter: 1.1, segments: 20
                }, this.scene);
                head.position.y = 3.8; // On top of torso
                head.scaling.set(0.9, 1.05, 0.95); // More realistic human head proportions
                head.parent = zombieGroup;
                
                // HUMAN ARMS - Hanging naturally like decayed human
                const leftArm = BABYLON.MeshBuilder.CreateCylinder("leftArm", {
                    height: 2.2, diameter: 0.35, tessellation: 12
                }, this.scene);
                leftArm.position.set(-1.2, 2.5, 0.1);
                leftArm.rotation.set(0.2, 0, 0.4); // Slightly forward like zombie reach
                leftArm.parent = zombieGroup;
                
                const rightArm = BABYLON.MeshBuilder.CreateCylinder("rightArm", {
                    height: 2.2, diameter: 0.35, tessellation: 12
                }, this.scene);
                rightArm.position.set(1.2, 2.5, 0.1);
                rightArm.rotation.set(0.2, 0, -0.4); // Slightly forward like zombie reach
                rightArm.parent = zombieGroup;
                
                // HUMAN LEGS - Standing upright
                const leftLeg = BABYLON.MeshBuilder.CreateCylinder("leftLeg", {
                    height: 3.2, diameter: 0.45, tessellation: 12
                }, this.scene);
                leftLeg.position.set(-0.4, -1.6, 0);
                leftLeg.parent = zombieGroup;
                
                const rightLeg = BABYLON.MeshBuilder.CreateCylinder("rightLeg", {
                    height: 3.2, diameter: 0.45, tessellation: 12
                }, this.scene);
                rightLeg.position.set(0.4, -1.6, 0);
                rightLeg.parent = zombieGroup;
                
                // REALISTIC ZOMBIE MATERIALS - Decayed human appearance
                const fleshMaterial = new BABYLON.StandardMaterial("zombieFleshMat", this.scene);
                fleshMaterial.diffuseColor = new BABYLON.Color3(0.7, 0.6, 0.5); // Decayed flesh color
                fleshMaterial.emissiveColor = new BABYLON.Color3(0.1, 0.06, 0.04); // Slight glow for visibility
                
                const clothingMaterial = new BABYLON.StandardMaterial("zombieClothingMat", this.scene);
                clothingMaterial.diffuseColor = new BABYLON.Color3(0.4, 0.3, 0.25); // Torn/dirty clothes
                clothingMaterial.emissiveColor = new BABYLON.Color3(0.05, 0.03, 0.02); // Slight glow
                
                // Apply materials like a real decayed human
                head.material = fleshMaterial;
                leftArm.material = fleshMaterial;
                rightArm.material = fleshMaterial;
                leftLeg.material = clothingMaterial; // Pants/clothing
                rightLeg.material = clothingMaterial;
                torso.material = clothingMaterial; // Shirt/clothing
                
                // BRIGHT ZOMBIE EYES
                const leftEye = BABYLON.MeshBuilder.CreateSphere("leftEye", {diameter: 0.15}, this.scene);
                leftEye.position.set(-0.25, 0.15, -0.45);
                leftEye.parent = head;
                
                const rightEye = BABYLON.MeshBuilder.CreateSphere("rightEye", {diameter: 0.15}, this.scene);
                rightEye.position.set(0.25, 0.15, -0.45);
                rightEye.parent = head;
                
                const eyeMaterial = new BABYLON.StandardMaterial("zombieEyes", this.scene);
                eyeMaterial.emissiveColor = new BABYLON.Color3(4, 0.5, 0.1); // Ultra bright red
                eyeMaterial.diffuseColor = new BABYLON.Color3(2, 0.2, 0.1);
                
                leftEye.material = eyeMaterial;
                rightEye.material = eyeMaterial;
                
                // Position zombie ON GROUND
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 80;
                zombieGroup.position.x = this.camera.position.x + Math.cos(angle) * distance;
                zombieGroup.position.z = this.camera.position.z + Math.sin(angle) * distance;
                zombieGroup.position.y = this.groundLevel; // EXACTLY on ground
                
                // Zombie data with all body parts
                const zombieData = {
                    group: zombieGroup,
                    mesh: torso,
                    health: 100,
                    speed: 0.15,
                    lastAttack: 0,
                    id: this.zombies.length,
                    parts: { head, torso, leftArm, rightArm, leftLeg, rightLeg },
                    animationTime: Math.random() * Math.PI * 2,
                    height: 5.5
                };
                
                this.zombies.push(zombieData);
                this.updateUI();
                
                console.log(`Humanoid zombie spawned at ground level! Total: ${this.zombies.length}`);
                return zombieData;
            }
            
            spawnWalkingZombies() {
                // Spawn several walking zombies
                for (let i = 0; i < 4; i++) {
                    setTimeout(() => this.createHumanoidZombie(), i * 2000);
                }
                
                // Continue spawning
                setInterval(() => {
                    if (this.zombies.length < 6 && this.gameStarted) {
                        this.createHumanoidZombie();
                    }
                }, 10000);
            }
            
            shoot() {
                if (this.ammo <= 0 || Date.now() - this.lastShot < this.shotCooldown) return;
                
                this.lastShot = Date.now();
                this.ammo--;
                this.updateUI();
                
                // Shooting effects
                this.createMuzzleFlash();
                
                // Raycast for hits
                const ray = new BABYLON.Ray(this.camera.position, this.camera.getForwardRay().direction);
                const hit = this.scene.pickWithRay(ray, (mesh) => {
                    return this.zombies.some(zombie => 
                        Object.values(zombie.parts).includes(mesh) || 
                        zombie.mesh === mesh
                    );
                });
                
                if (hit.hit && hit.distance < 200) {
                    const hitZombie = this.zombies.find(zombie => 
                        Object.values(zombie.parts).includes(hit.pickedMesh) || 
                        zombie.mesh === hit.pickedMesh
                    );
                    
                    if (hitZombie) {
                        this.killZombie(hitZombie);
                    }
                }
            }
            
            createMuzzleFlash() {
                const flash = BABYLON.MeshBuilder.CreateSphere("muzzleFlash", {diameter: 3}, this.scene);
                flash.position = this.camera.position.add(this.camera.getForwardRay().direction.scale(4));
                
                const flashMaterial = new BABYLON.StandardMaterial("flashMat", this.scene);
                flashMaterial.emissiveColor = new BABYLON.Color3(1.5, 1.2, 0.5);
                flash.material = flashMaterial;
                
                setTimeout(() => flash.dispose(), 100);
            }
            
            killZombie(zombie) {
                console.log(`Killing zombie ${zombie.id}`);
                
                // Remove zombie
                zombie.group.dispose();
                this.zombies = this.zombies.filter(z => z.id !== zombie.id);
                
                this.kills++;
                this.updateUI();
            }
            
            updateZombies() {
                if (!this.gameStarted) return;
                
                this.zombies.forEach(zombieData => {
                    const zombie = zombieData.group;
                    
                    // CRITICAL: Move zombie toward player but KEEP ON GROUND
                    const playerPos = this.camera.position.clone();
                    const zombiePos = zombie.position.clone();
                    
                    // Calculate direction on ground plane only
                    playerPos.y = this.groundLevel;
                    zombiePos.y = this.groundLevel;
                    
                    const direction = playerPos.subtract(zombiePos).normalize();
                    
                    // Move zombie on ground ONLY
                    const movement = direction.scale(zombieData.speed);
                    movement.y = 0; // NO vertical movement
                    zombie.position.addInPlace(movement);
                    
                    // FORCE zombie to stay on ground
                    zombie.position.y = this.groundLevel;
                    
                    // Face player
                    zombie.lookAt(this.camera.position);
                    
                    // Simple walking animation
                    zombieData.animationTime += 0.1;
                    const walkBob = Math.sin(zombieData.animationTime) * 0.05;
                    zombie.position.y = this.groundLevel + Math.max(0, walkBob);
                    
                    // Attack when close
                    const distance = BABYLON.Vector3.Distance(zombie.position, this.camera.position);
                    if (distance < 8 && Date.now() - zombieData.lastAttack > 3000) {
                        this.health -= 25;
                        zombieData.lastAttack = Date.now();
                        this.updateUI();
                        
                        if (this.health <= 0) {
                            setTimeout(() => {
                                alert(`üíÄ GAME OVER üíÄ\n\nKilled by walking zombies!\n\nüèÜ Kills: ${this.kills}\n\nTry again?`);
                                location.reload();
                            }, 500);
                        }
                    }
                });
            }
            
            handleMovement() {
                if (!this.isPointerLocked) return;
                
                const speed = this.inputMap['Shift'] ? 0.8 : 0.5;
                
                // Calculate movement direction
                let moveVector = new BABYLON.Vector3(0, 0, 0);
                
                if (this.inputMap['w']) {
                    const forward = this.camera.getForwardRay().direction.clone();
                    forward.y = 0; // Remove vertical component - stay on ground
                    moveVector.addInPlace(forward.normalize().scale(speed));
                }
                if (this.inputMap['s']) {
                    const backward = this.camera.getForwardRay().direction.clone();
                    backward.y = 0; // Remove vertical component
                    moveVector.addInPlace(backward.normalize().scale(-speed));
                }
                if (this.inputMap['a']) {
                    const left = BABYLON.Vector3.Cross(this.camera.getForwardRay().direction, BABYLON.Vector3.Up()).normalize();
                    left.y = 0; // Remove vertical component
                    moveVector.addInPlace(left.scale(-speed));
                }
                if (this.inputMap['d']) {
                    const right = BABYLON.Vector3.Cross(this.camera.getForwardRay().direction, BABYLON.Vector3.Up()).normalize();
                    right.y = 0; // Remove vertical component
                    moveVector.addInPlace(right.scale(speed));
                }
                
                // Apply movement but KEEP CAMERA AT GROUND + PLAYER HEIGHT
                this.camera.position.addInPlace(moveVector);
                this.camera.position.y = this.groundLevel + this.playerHeight; // FORCE camera to ground level
                
                if (this.inputMap['f']) {
                    this.flashlight.intensity = this.flashlight.intensity > 0 ? 0 : 15;
                    this.inputMap['f'] = false;
                }
                if (this.inputMap['Escape']) {
                    if (this.isPointerLocked) {
                        document.exitPointerLock();
                    }
                }
            }
            
            updateUI() {
                document.getElementById('health').textContent = this.health;
                document.getElementById('ammo').textContent = this.ammo;
                document.getElementById('kills').textContent = this.kills;
                document.getElementById('zombieCount').textContent = this.zombies.length;
                
                // Update flashlight
                if (this.flashlight && this.camera) {
                    this.flashlight.position = this.camera.position.clone();
                    this.flashlight.direction = this.camera.getForwardRay().direction;
                }
            }
            
            startGame() {
                this.updateUI();
                console.log("Truly grounded zombie game loaded!");
            }
            
            gameLoop() {
                this.engine.runRenderLoop(() => {
                    this.handleMovement();
                    this.updateZombies();
                    this.updateUI();
                    this.scene.render();
                });
            }
        }
        
        // Launch truly grounded game
        window.addEventListener('load', () => {
            new TrulyGroundedGame();
        });
    </script>
</body>
</html>